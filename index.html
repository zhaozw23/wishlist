<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Wishlist</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9/dist/leaflet.css">
    <script src="https://unpkg.com/leaflet@1.9/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
</head>
<body>

<div class="hearts-bg" id="heartsBg"></div>

<!-- Login -->
<div id="loginScreen" style="display:none">
    <div class="login-box">
        <div class="heart-icon">&#10084;</div>
        <h1>Family Wishlist</h1>
        <p>&#10084; 请输入密码访问 &#10084;</p>
        <div class="form-row">
            <input type="password" id="loginPassword" placeholder="密码" autofocus>
            <button class="btn btn-primary" onclick="checkPassword()">进入</button>
        </div>
        <p id="loginError" style="color:#e74c3c;font-size:0.85rem;margin-top:8px;display:none">密码错误</p>
    </div>
</div>

<!-- App -->
<div id="appMain" style="display:none">
<header>
    <h1>&#10084; Family Wishlist</h1>
    <div class="user-selector">
        <span>当前用户:</span>
        <select id="currentUser"></select>
    </div>
</header>

<div class="container">
    <div class="countdown-section" id="countdownSection"></div>

    <!-- ========== GIFTS ========== -->
    <div class="tab-content" id="tab-gifts">
        <div class="section-header" data-theme="gifts">
            <div class="section-icon">&#127873;</div>
            <div class="section-title">礼物心愿</div>
        </div>
        <div class="add-form">
            <div class="form-row">
                <input type="text" id="wishTitle" placeholder="想要什么..." maxlength="200">
            </div>
            <div class="form-row">
                <input type="url" id="wishLink" placeholder="商品链接 (可选)">
                <button class="btn btn-primary" onclick="addWish()">添加</button>
            </div>
        </div>
        <div data-theme="gifts">
            <div class="sub-tabs">
                <div class="tab active" data-status="active" onclick="switchWishStatus('active')">&#10024; 想要的</div>
                <div class="tab" data-status="fulfilled" onclick="switchWishStatus('fulfilled')">&#10004; 已实现</div>
            </div>
        </div>
        <div class="filter-row" id="giftFilterRow"></div>
        <div id="wishList"></div>
    </div>

    <!-- ========== TRAVEL ========== -->
    <div class="tab-content" id="tab-travel" style="display:none">
        <div class="section-header" data-theme="travel">
            <div class="section-icon">&#9992;&#65039;</div>
            <div class="section-title">旅行清单</div>
        </div>

        <!-- Map -->
        <div class="map-wrapper">
            <div id="travelMap"></div>
            <div class="map-legend">
                <span class="legend-item"><span class="legend-dot pending"></span>想去的</span>
                <span class="legend-item"><span class="legend-dot visited"></span>去过了</span>
            </div>
        </div>

        <div class="add-form">
            <div class="form-row">
                <input type="text" id="travelDest" placeholder="想去哪里..." maxlength="200">
            </div>
            <div class="form-row coord-row">
                <input type="number" id="coordLat" placeholder="纬度" step="any" min="0" max="90">
                <select id="coordNS"><option value="N">N 北纬</option><option value="S">S 南纬</option></select>
                <input type="number" id="coordLng" placeholder="经度" step="any" min="0" max="180">
                <select id="coordEW"><option value="E">E 东经</option><option value="W">W 西经</option></select>
                <button class="btn btn-outline btn-small" onclick="clearCoord()" title="清除坐标" style="padding:6px 10px">&#10005;</button>
            </div>
            <div class="form-row">
                <input type="url" id="travelLink" placeholder="相关链接 (可选)">
            </div>
            <div class="form-row">
                <input type="text" id="travelNote" placeholder="备注 (可选)" maxlength="500">
                <button class="btn btn-travel" onclick="addTravel()">添加</button>
            </div>
        </div>
        <div data-theme="travel">
            <div class="sub-tabs">
                <div class="tab active" data-status="pending" onclick="switchTravelStatus('pending')">&#127758; 想去的</div>
                <div class="tab" data-status="done" onclick="switchTravelStatus('done')">&#10004; 去过了</div>
            </div>
        </div>
        <div id="travelList"></div>
    </div>

    <!-- ========== RESTAURANT ========== -->
    <div class="tab-content" id="tab-restaurant" style="display:none">
        <div class="section-header" data-theme="restaurant">
            <div class="section-icon">&#127860;</div>
            <div class="section-title">纪念日餐厅</div>
        </div>
        <div class="add-form">
            <div class="form-row">
                <input type="text" id="restName" placeholder="餐厅名..." maxlength="200">
            </div>
            <div class="form-row">
                <input type="url" id="restLink" placeholder="餐厅链接 (可选)">
            </div>
            <div class="form-row">
                <input type="text" id="restNote" placeholder="备注 (可选)" maxlength="500">
                <button class="btn btn-rest" onclick="addRestaurant()">添加</button>
            </div>
        </div>
        <div data-theme="restaurant">
            <div class="sub-tabs">
                <div class="tab active" data-status="pending" onclick="switchRestStatus('pending')">&#128141; 想去的</div>
                <div class="tab" data-status="visited" onclick="switchRestStatus('visited')">&#10004; 去过了</div>
            </div>
        </div>
        <div id="restaurantList"></div>
    </div>

    <!-- Done modal (shared by travel & restaurant) -->
    <div class="modal-overlay" id="doneModal" style="display:none" onclick="if(event.target===this)closeDoneModal()">
        <div class="modal-box">
            <h2 id="doneModalTitle"></h2>
            <input type="hidden" id="doneModalId">
            <input type="hidden" id="doneModalType">
            <div class="form-row"><label>日期</label></div>
            <div class="form-row"><input type="date" id="doneModalDate"></div>
            <div class="form-row"><label id="doneModalReviewLabel">总结</label></div>
            <div class="form-row"><textarea id="doneModalReview" rows="3"></textarea></div>
            <div class="form-row" style="justify-content:flex-end;gap:10px">
                <button class="btn btn-outline" onclick="closeDoneModal()">取消</button>
                <button class="btn btn-primary" id="doneModalBtn" onclick="submitDoneModal()">确认</button>
            </div>
        </div>
    </div>

    <!-- Members -->
    <div class="member-section">
        <h2>&#128106; 家庭成员</h2>
        <div class="member-list" id="memberList"></div>
        <div class="form-row">
            <input type="text" id="memberName" placeholder="新成员名字" maxlength="50">
            <button class="btn btn-outline" onclick="addMember()">添加成员</button>
        </div>
    </div>
</div>

<!-- Bottom nav -->
<nav class="bottom-nav">
    <div class="nav-item active" data-tab="gifts" onclick="switchMainTab('gifts')">
        <span class="nav-icon">&#127873;</span>
        <span class="nav-label">礼物心愿</span>
    </div>
    <div class="nav-item" data-tab="travel" onclick="switchMainTab('travel')">
        <span class="nav-icon">&#9992;&#65039;</span>
        <span class="nav-label">旅行清单</span>
    </div>
    <div class="nav-item" data-tab="restaurant" onclick="switchMainTab('restaurant')">
        <span class="nav-icon">&#127860;</span>
        <span class="nav-label">纪念日餐厅</span>
    </div>
</nav>

</div><!-- end appMain -->

<script>
// ==================== Auth ====================
const PWD_HASH = 'ec38f5b04b1f1445b150678d81f4019f5e503d83eff4be3b49d638b1812738c3';

async function sha256(text) {
    const data = new TextEncoder().encode(text);
    const buf = await crypto.subtle.digest('SHA-256', data);
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function checkPassword() {
    const input = document.getElementById('loginPassword').value;
    const hash = await sha256(input);
    if (hash === PWD_HASH) {
        localStorage.setItem('wishlist_auth', hash);
        showApp();
    } else {
        document.getElementById('loginError').style.display = 'block';
    }
}

function showApp() {
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('appMain').style.display = 'block';
    renderCountdown();
    loadMembers().then(() => { loadWishes(); loadTravels(); loadRestaurants(); });
}

function initAuth() {
    createFloatingHearts();
    if (localStorage.getItem('wishlist_auth') === PWD_HASH) showApp();
    else document.getElementById('loginScreen').style.display = 'flex';
}

document.getElementById('loginPassword').addEventListener('keydown', e => { if (e.key === 'Enter') checkPassword(); });

// ==================== Hearts ====================
function createFloatingHearts() {
    const c = document.getElementById('heartsBg');
    const h = ['\u2764','\u2765','\u2763','\u2661'];
    for (let i = 0; i < 15; i++) {
        const s = document.createElement('span');
        s.textContent = h[i % h.length];
        s.style.left = Math.random()*100+'%';
        s.style.animationDelay = Math.random()*15+'s';
        s.style.animationDuration = (12+Math.random()*10)+'s';
        s.style.fontSize = (0.8+Math.random()*1.2)+'rem';
        c.appendChild(s);
    }
}

// ==================== Countdown ====================
const QIXI = {2025:'2025-08-29',2026:'2026-08-19',2027:'2027-08-08',2028:'2028-08-26',2029:'2029-08-16',2030:'2030-08-05',2031:'2031-08-24',2032:'2032-08-12',2033:'2033-08-01',2034:'2034-08-20',2035:'2035-08-09'};

function daysUntil(m,d) {
    const t = new Date(); t.setHours(0,0,0,0);
    let x = new Date(t.getFullYear(), m-1, d);
    if (x < t) x = new Date(t.getFullYear()+1, m-1, d);
    return Math.ceil((x-t)/864e5);
}

function nextQixi() {
    const t = new Date(); t.setHours(0,0,0,0);
    for (let y = t.getFullYear(); y <= 2035; y++)
        if (QIXI[y]) { const d = new Date(QIXI[y]+'T00:00:00'); if (d >= t) return Math.ceil((d-t)/864e5); }
    return '?';
}

function renderCountdown() {
    const start = new Date(2024,6,14), now = new Date(); now.setHours(0,0,0,0);
    const together = Math.floor((now-start)/864e5);
    const items = [
        {e:'\u{1F491}',l:'在一起',d:together,u:'天',info:'2024.7.14 起',t:true},
        {e:'\u{1F382}',l:'Yirui 生日',d:daysUntil(2,5),u:'天后',info:'2月5日'},
        {e:'\u{1F382}',l:'Ziwen 生日',d:daysUntil(1,27),u:'天后',info:'1月27日'},
        {e:'\u{1F495}',l:'在一起纪念日',d:daysUntil(7,14),u:'天后',info:'7月14日'},
        {e:'\u{1F48D}',l:'求婚纪念日',d:nextQixi(),u:'天后',info:'七夕'},
        {e:'\u{1F492}',l:'结婚纪念日',d:daysUntil(2,10),u:'天后',info:'2月10日'},
    ];
    document.getElementById('countdownSection').innerHTML = '<div class="countdown-grid">' + items.map(i => {
        const today = i.d===0 && !i.t;
        return `<div class="countdown-card ${i.t?'together':''}">
            <div class="emoji">${i.e}</div><div class="label">${i.l}</div>
            <div class="days">${today?'&#127881;':i.d}</div>
            <div class="days-label">${today?'就是今天!':i.u}</div>
            <div class="date-info">${i.info}</div></div>`;
    }).join('') + '</div>';
}

// ==================== Supabase ====================
const sb = supabase.createClient(
    'https://vcbzdslaoumewqhjmojr.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZjYnpkc2xhb3VtZXdxaGptb2pyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNjI1OTcsImV4cCI6MjA4NzczODU5N30.WhfPPljwTsm_kUEx02hWF_nU6_oqrKJmF4pqjg8Nhfw'
);

const COLORS = ['#e8607c','#5b8def','#f0a030','#27ae60','#9b59b6','#1abc9c','#e67e22','#3498db'];
let members = [];
let wishStatus = 'active', travelStatus = 'pending', restStatus = 'pending', giftFilter = null;

function mColor(id) { return COLORS[(id-1)%COLORS.length]; }
function esc(s) { if(!s)return''; const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

// ==================== Map ====================
let travelMap = null, mapMarkers = [], pickMarker = null;

function initMap() {
    if (travelMap) return;
    travelMap = L.map('travelMap', {zoomControl: true, minZoom: 2}).setView([30, 110], 3);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap',
        maxZoom: 18
    }).addTo(travelMap);
    travelMap.on('click', function(e) {
        const {lat, lng} = e.latlng;
        document.getElementById('coordLat').value = Math.abs(lat).toFixed(5);
        document.getElementById('coordNS').value = lat >= 0 ? 'N' : 'S';
        document.getElementById('coordLng').value = Math.abs(lng).toFixed(5);
        document.getElementById('coordEW').value = lng >= 0 ? 'E' : 'W';
        if (pickMarker) travelMap.removeLayer(pickMarker);
        pickMarker = L.circleMarker([lat, lng], {radius:8, color:'#333', fillColor:'#fff', fillOpacity:1, weight:2}).addTo(travelMap);
    });
}

function clearCoord() {
    document.getElementById('coordLat').value = '';
    document.getElementById('coordLng').value = '';
    document.getElementById('coordNS').value = 'N';
    document.getElementById('coordEW').value = 'E';
    if (pickMarker) { travelMap.removeLayer(pickMarker); pickMarker = null; }
}

function getCoordValues() {
    const latVal = parseFloat(document.getElementById('coordLat').value);
    const lngVal = parseFloat(document.getElementById('coordLng').value);
    if (isNaN(latVal) || isNaN(lngVal)) return null;
    const lat = document.getElementById('coordNS').value === 'S' ? -latVal : latVal;
    const lng = document.getElementById('coordEW').value === 'W' ? -lngVal : lngVal;
    return {lat, lng};
}

function refreshMapMarkers(allTravels) {
    if (!travelMap) return;
    mapMarkers.forEach(m => travelMap.removeLayer(m));
    mapMarkers = [];
    const bounds = [];
    allTravels.forEach(t => {
        if (t.lat == null || t.lng == null) return;
        const done = t.fulfilled;
        const color = done ? '#27ae60' : '#5b8def';
        const icon = done ? '\u2714' : '\u2708';
        const marker = L.circleMarker([t.lat, t.lng], {
            radius: 9, color: '#fff', weight: 2, fillColor: color, fillOpacity: 0.9
        }).addTo(travelMap);
        marker.bindPopup(`<b>${esc(t.destination)}</b><br><span style="color:${color}">${done?'已去过':'想去的'}</span>${t.note?'<br>'+esc(t.note):''}`);
        mapMarkers.push(marker);
        bounds.push([t.lat, t.lng]);
    });
    if (bounds.length > 1) travelMap.fitBounds(bounds, {padding:[30,30], maxZoom:8});
    else if (bounds.length === 1) travelMap.setView(bounds[0], 6);
}

// ==================== Tabs ====================
function switchMainTab(tab) {
    document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.tab===tab));
    document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
    document.getElementById('tab-'+tab).style.display = 'block';
    if (tab === 'travel') {
        if (!travelMap) initMap();
        else setTimeout(() => travelMap.invalidateSize(), 100);
    }
}

// ==================== Members ====================
async function loadMembers() {
    const {data} = await sb.from('members').select('*').order('id');
    members = data||[];
    const sel = document.getElementById('currentUser');
    const saved = localStorage.getItem('wishlist_user');
    sel.innerHTML = members.map(m => `<option value="${m.id}" ${m.id==saved?'selected':''}>${m.name}</option>`).join('');
    if (!saved && members.length) localStorage.setItem('wishlist_user', members[0].id);
    sel.onchange = () => localStorage.setItem('wishlist_user', sel.value);
    renderGiftFilters();
    document.getElementById('memberList').innerHTML = members.map(m =>
        `<span class="member-chip" style="background:${mColor(m.id)}18;color:${mColor(m.id)}">${m.name}<span class="delete-member" onclick="deleteMember(${m.id},'${esc(m.name)}')">&times;</span></span>`
    ).join('');
}

async function addMember() {
    const input = document.getElementById('memberName');
    const name = input.value.trim();
    if (!name) return;
    const {error} = await sb.from('members').insert({name});
    if (error) { alert(error.message.includes('duplicate')?'该成员已存在':error.message); return; }
    input.value = '';
    await loadMembers(); loadWishes(); loadTravels(); loadRestaurants();
}

async function deleteMember(id, name) {
    if (!confirm('确定要删除成员 '+name+' 吗？\n该成员的所有记录也会被删除。')) return;
    await sb.from('wishes').delete().eq('member_id', id);
    await sb.from('travels').delete().eq('member_id', id);
    await sb.from('restaurants').delete().eq('member_id', id);
    await sb.from('wishes').update({fulfilled_by:null}).eq('fulfilled_by', id);
    await sb.from('members').delete().eq('id', id);
    await loadMembers(); loadWishes(); loadTravels(); loadRestaurants();
}

// ==================== GIFTS ====================
function renderGiftFilters() {
    document.getElementById('giftFilterRow').innerHTML =
        `<div class="filter-chip ${giftFilter===null?'active':''}" onclick="setGiftFilter(null)">全部</div>` +
        members.map(m => `<div class="filter-chip ${giftFilter===m.id?'active':''}" onclick="setGiftFilter(${m.id})">${m.name}</div>`).join('');
}
function setGiftFilter(id) { giftFilter=id; renderGiftFilters(); loadWishes(); }
function switchWishStatus(s) {
    wishStatus=s;
    document.querySelectorAll('#tab-gifts .sub-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.status===s));
    loadWishes();
}

async function loadWishes() {
    let q = sb.from('wishes').select('*, member:members!member_id(name), fulfiller:members!fulfilled_by(name)');
    q = q.eq('fulfilled', wishStatus==='fulfilled');
    if (giftFilter) q = q.eq('member_id', giftFilter);
    q = q.order('created_at', {ascending:false});
    const {data,error} = await q;
    const el = document.getElementById('wishList');
    if (error) { el.innerHTML=`<div class="empty-state">加载失败</div>`; return; }
    if (!data||!data.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">&#127873;</div>${wishStatus==='active'?'暂无心愿，快来许愿吧':'还没有已实现的心愿'}</div>`; return; }

    el.innerHTML = data.map(w => {
        const c = mColor(w.member_id), date = new Date(w.created_at).toLocaleDateString('zh-CN');
        const title = w.link ? `<a href="${esc(w.link)}" target="_blank">${esc(w.title)}</a>` : esc(w.title);
        const del = `<button class="btn-delete" onclick="deleteItem('wishes',${w.id})" title="删除">&times;</button>`;
        const act = wishStatus==='active'
            ? `<button class="btn btn-primary btn-small" onclick="fulfillWish(${w.id})">&#10084; 实现</button>`
            : `<button class="btn btn-outline btn-small" onclick="unfulfillWish(${w.id})">撤回</button>`;
        let meta = `<span class="member-tag" style="background:${c}18;color:${c}">${esc(w.member?.name)}</span><span>${date}</span>`;
        if (wishStatus==='fulfilled' && w.fulfiller?.name) meta += `<span>由 ${esc(w.fulfiller.name)} 实现</span>`;
        return `<div class="item-card ${wishStatus==='fulfilled'?'done':''}" style="border-left-color:${c}">${del}
            <div class="card-info"><div class="card-title">${title}</div><div class="card-meta">${meta}</div></div>
            <div class="card-actions">${act}</div></div>`;
    }).join('');
}

async function addWish() {
    const title = document.getElementById('wishTitle').value.trim();
    const link = document.getElementById('wishLink').value.trim();
    const mid = parseInt(document.getElementById('currentUser').value);
    if (!title) return;
    await sb.from('wishes').insert({title, link:link||null, member_id:mid});
    document.getElementById('wishTitle').value=''; document.getElementById('wishLink').value='';
    loadWishes();
}
async function fulfillWish(id) {
    await sb.from('wishes').update({fulfilled:true, fulfilled_at:new Date().toISOString(), fulfilled_by:parseInt(document.getElementById('currentUser').value)}).eq('id',id);
    loadWishes();
}
async function unfulfillWish(id) {
    await sb.from('wishes').update({fulfilled:false, fulfilled_at:null, fulfilled_by:null}).eq('id',id);
    loadWishes();
}

// ==================== TRAVEL ====================
function switchTravelStatus(s) {
    travelStatus=s;
    document.querySelectorAll('#tab-travel .sub-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.status===s));
    loadTravels();
}

async function loadTravels() {
    // Load ALL travels for the map, then filter for the list
    const {data:allData} = await sb.from('travels').select('*, member:members!member_id(name)').order('created_at',{ascending:false});
    refreshMapMarkers(allData || []);

    const data = (allData||[]).filter(t => t.fulfilled === (travelStatus==='done'));
    const el = document.getElementById('travelList');
    if (!data.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">&#9992;&#65039;</div>${travelStatus==='pending'?'还没有想去的地方，快来添加吧':'还没有去过的旅行'}</div>`; return; }

    el.innerHTML = data.map(t => {
        const c = mColor(t.member_id), date = new Date(t.created_at).toLocaleDateString('zh-CN');
        const title = t.link ? `<a href="${esc(t.link)}" target="_blank">${esc(t.destination)}</a>` : esc(t.destination);
        const note = t.note ? `<div class="card-note">${esc(t.note)}</div>` : '';
        const coordLink = (t.lat!=null && t.lng!=null)
            ? `<span class="coord-link" onclick="flyTo(${t.lat},${t.lng})">&#128205; ${t.lat.toFixed(2)}, ${t.lng.toFixed(2)}</span>` : '';
        const reviewHtml = (travelStatus==='done' && t.review) ? `<div class="review-box">&#128221; ${esc(t.review)}</div>` : '';
        const del = `<button class="btn-delete" onclick="deleteItem('travels',${t.id})" title="删除">&times;</button>`;
        const act = travelStatus==='pending'
            ? `<button class="btn btn-travel btn-small" onclick="openDoneModal(${t.id},'travel')">&#9992;&#65039; 去过了</button>`
            : `<button class="btn btn-outline btn-small" onclick="unfulfillTravel(${t.id})">撤回</button>`;
        let meta = `<span class="member-tag" style="background:${c}18;color:${c}">${esc(t.member?.name)}</span><span>${date}</span>${coordLink}`;
        if (travelStatus==='done' && t.fulfilled_at) meta += `<span>去过 ${new Date(t.fulfilled_at).toLocaleDateString('zh-CN')}</span>`;
        return `<div class="item-card theme-travel ${travelStatus==='done'?'done':''}" style="border-left-color:${c}">${del}
            <div class="card-info"><div class="card-title">${title}</div>${note}${reviewHtml}<div class="card-meta">${meta}</div></div>
            <div class="card-actions">${act}</div></div>`;
    }).join('');
}

function flyTo(lat, lng) {
    if (travelMap) travelMap.flyTo([lat, lng], 8);
    window.scrollTo({top: document.getElementById('travelMap').offsetTop - 60, behavior:'smooth'});
}

async function addTravel() {
    const dest = document.getElementById('travelDest').value.trim();
    const link = document.getElementById('travelLink').value.trim();
    const note = document.getElementById('travelNote').value.trim();
    const mid = parseInt(document.getElementById('currentUser').value);
    if (!dest) return;
    const coord = getCoordValues();
    const lat = coord ? coord.lat : null;
    const lng = coord ? coord.lng : null;
    await sb.from('travels').insert({destination:dest, link:link||null, note:note||null, member_id:mid, lat, lng});
    document.getElementById('travelDest').value=''; document.getElementById('travelLink').value='';
    document.getElementById('travelNote').value=''; clearCoord();
    loadTravels();
}
async function unfulfillTravel(id) { await sb.from('travels').update({fulfilled:false, fulfilled_at:null, review:null}).eq('id',id); loadTravels(); }

// ==================== RESTAURANTS ====================
function switchRestStatus(s) {
    restStatus=s;
    document.querySelectorAll('#tab-restaurant .sub-tabs .tab').forEach(t => t.classList.toggle('active', t.dataset.status===s));
    loadRestaurants();
}

async function loadRestaurants() {
    let q = sb.from('restaurants').select('*, member:members!member_id(name)');
    q = q.eq('visited', restStatus==='visited').order('created_at',{ascending:false});
    const {data,error} = await q;
    const el = document.getElementById('restaurantList');
    if (error) { el.innerHTML=`<div class="empty-state">加载失败</div>`; return; }
    if (!data||!data.length) { el.innerHTML=`<div class="empty-state"><div class="empty-icon">&#127860;</div>${restStatus==='pending'?'还没有想去的餐厅，快来添加吧':'还没有去过的餐厅'}</div>`; return; }

    el.innerHTML = data.map(r => {
        const c = mColor(r.member_id), date = new Date(r.created_at).toLocaleDateString('zh-CN');
        const title = r.link ? `<a href="${esc(r.link)}" target="_blank">${esc(r.name)}</a>` : esc(r.name);
        const note = r.note ? `<div class="card-note">${esc(r.note)}</div>` : '';
        const review = (restStatus==='visited' && r.review) ? `<div class="review-box">&#128221; ${esc(r.review)}</div>` : '';
        const del = `<button class="btn-delete" onclick="deleteItem('restaurants',${r.id})" title="删除">&times;</button>`;
        const act = restStatus==='pending'
            ? `<button class="btn btn-rest btn-small" onclick="openDoneModal(${r.id},'restaurant')">&#127860; 去过了</button>`
            : `<button class="btn btn-outline btn-small" onclick="unvisitRest(${r.id})">撤回</button>`;
        let meta = `<span class="member-tag" style="background:${c}18;color:${c}">${esc(r.member?.name)}</span><span>${date}</span>`;
        if (restStatus==='visited' && r.visited_at) meta += `<span>去过 ${r.visited_at}</span>`;
        return `<div class="item-card theme-rest ${restStatus==='visited'?'done':''}" style="border-left-color:${c}">${del}
            <div class="card-info"><div class="card-title">${title}</div>${note}${review}<div class="card-meta">${meta}</div></div>
            <div class="card-actions">${act}</div></div>`;
    }).join('');
}

async function addRestaurant() {
    const name = document.getElementById('restName').value.trim();
    const link = document.getElementById('restLink').value.trim();
    const note = document.getElementById('restNote').value.trim();
    const mid = parseInt(document.getElementById('currentUser').value);
    if (!name) return;
    await sb.from('restaurants').insert({name, link:link||null, note:note||null, member_id:mid});
    document.getElementById('restName').value=''; document.getElementById('restLink').value=''; document.getElementById('restNote').value='';
    loadRestaurants();
}

// ==================== Shared Done Modal ====================
const MODAL_CONFIG = {
    travel: {
        title: '&#9992;&#65039; 记录旅行体验',
        reviewLabel: '总结 (可选)',
        placeholder: '旅行感受、推荐理由...',
        btnClass: 'btn-travel'
    },
    restaurant: {
        title: '&#127860; 记录用餐体验',
        reviewLabel: '点评 (可选)',
        placeholder: '味道怎么样？推荐什么菜？',
        btnClass: 'btn-rest'
    }
};

function openDoneModal(id, type) {
    const cfg = MODAL_CONFIG[type];
    document.getElementById('doneModalId').value = id;
    document.getElementById('doneModalType').value = type;
    document.getElementById('doneModalTitle').innerHTML = cfg.title;
    document.getElementById('doneModalReviewLabel').textContent = cfg.reviewLabel;
    document.getElementById('doneModalReview').placeholder = cfg.placeholder;
    document.getElementById('doneModalDate').value = new Date().toISOString().slice(0,10);
    document.getElementById('doneModalReview').value = '';
    const btn = document.getElementById('doneModalBtn');
    btn.className = 'btn ' + cfg.btnClass;
    document.getElementById('doneModal').style.display = 'flex';
}

function closeDoneModal() { document.getElementById('doneModal').style.display = 'none'; }

async function submitDoneModal() {
    const id = parseInt(document.getElementById('doneModalId').value);
    const type = document.getElementById('doneModalType').value;
    const dateVal = document.getElementById('doneModalDate').value || null;
    const review = document.getElementById('doneModalReview').value.trim() || null;

    if (type === 'travel') {
        // fulfilled_at is TIMESTAMPTZ, convert date to full ISO string
        const ts = dateVal ? new Date(dateVal + 'T00:00:00').toISOString() : new Date().toISOString();
        const {error} = await sb.from('travels').update({fulfilled:true, fulfilled_at:ts, review}).eq('id',id);
        if (error) { alert('操作失败: ' + error.message); return; }
        closeDoneModal(); loadTravels();
    } else {
        const {error} = await sb.from('restaurants').update({visited:true, visited_at:dateVal, review}).eq('id',id);
        if (error) { alert('操作失败: ' + error.message); return; }
        closeDoneModal(); loadRestaurants();
    }
}

async function deleteItem(table, id) {
    if (!confirm('确定要删除吗？')) return;
    await sb.from(table).delete().eq('id', id);
    if (table === 'wishes') loadWishes();
    else if (table === 'travels') loadTravels();
    else if (table === 'restaurants') loadRestaurants();
}

async function unvisitRest(id) {
    await sb.from('restaurants').update({visited:false, visited_at:null, review:null}).eq('id',id);
    loadRestaurants();
}

// ==================== Enter key ====================
['wishTitle','wishLink'].forEach(id => document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') addWish(); }));
['travelDest','coordLat','coordLng','travelLink','travelNote'].forEach(id => document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') addTravel(); }));
['restName','restLink','restNote'].forEach(id => document.getElementById(id).addEventListener('keydown', e => { if(e.key==='Enter') addRestaurant(); }));
document.getElementById('memberName').addEventListener('keydown', e => { if(e.key==='Enter') addMember(); });

initAuth();
</script>
</body>
</html>
